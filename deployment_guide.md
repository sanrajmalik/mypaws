# ðŸš€ mypaws Production Deployment Guide

This guide explains how to deploy `mypaws` on your existing server alongside `whatomate`.

## 1. Prerequisites

You already have:
-   Running `whatomate` stack (Postgres, Redis).
-   `whatomate` network created (verify with `docker network ls`).
-   Postgres user/pass: `whatomate` / `whatomate123`.

### Why Build on Server? (No Docker Hub Cost)
This guide uses the **"Build on Server"** strategy. Instead of pushing images to a private registry (like Docker Hub, which limits free accounts to 1 private repository), we upload the source code and build the images directly on your server. This is free and avoids the complexity of managing multiple private repositories for your Frontend and Backend services.

## 2. Prepare Database

Since Postgres is already running, it won't auto-create the `mypaws` database from the new docker-compose. You must do this manually.

1.  **SSH into your server**.
2.  **Connect to the running Postgres container**:
    ```bash
    docker exec -it whatomate_db psql -U whatomate -d whatomate
    ```
3.  **Run these SQL commands**:
    ```sql
    -- Create the new user
    CREATE USER mypaws WITH PASSWORD 'StrongPasswordForMyPawsDB123!';

    -- Create the database
    CREATE DATABASE mypaws OWNER mypaws;

    -- Grant privileges (optional but recommended verification)
    GRANT ALL PRIVILEGES ON DATABASE mypaws TO mypaws;
    ```
4.  **Exit**: `\q`

## 3. Upload Files

Use SFTP to upload your project files to a new directory on the server, e.g., `/opt/mypaws` or `/root/mypaws`.

**Files to Upload:**
*   `backend/` (Directory)
*   `frontend/` (Directory)
*   `docker-compose.prod.yml`
*   `.env.prod` (Create this file, see below)

**Note**: You do NOT need to upload `node_modules`, `bin`, `obj`, or `.git`.

## 4. Create .env.prod

Create a `.env.prod` file on the server in the `mypaws` directory:

```ini
# Database (Matches the password you set in step 2)
DB_PASSWORD=StrongPasswordForMyPawsDB123!

# Auth
JWT_SECRET=generate-a-very-long-random-secret-string-here-minimum-32-chars
GOOGLE_CLIENT_ID=your-google-client-id.apps.googleusercontent.com

# Domain
NEXT_PUBLIC_BASE_URL=https://mypaws.com
```

## 5. Start the Application

Run the production compose file:

```bash
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d --build
```

## 6. Configure Nginx

You found your Nginx config at `/etc/nginx/nginx.conf`. **Do not edit this file directly.** The best practice on Ubuntu/Debian is to create a new file in `/etc/nginx/sites-available`.

1.  **Create the configuration file**:
    ```bash
    sudo nano /etc/nginx/sites-available/mypaws
    ```

2.  **Paste the following content** (Update `server_name` with your domain):
    ```nginx
    server {
        listen 80;
        server_name mypaws.com www.mypaws.com;

        # Frontend (Next.js)
        location / {
            proxy_pass http://127.0.0.1:3001;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

        # Backend API (ASP.NET Core)
        location /api {
            proxy_pass http://127.0.0.1:5001;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection keep-alive;
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Static Uploads
        location /uploads {
            alias /opt/mypaws/backend/src/Mypaws.Api/wwwroot/uploads; # Update this path to match your upload location
            expires 30d;
            access_log off;
        }
    }
    ```

3.  **Enable the site**:
    ```bash
    sudo ln -s /etc/nginx/sites-available/mypaws /etc/nginx/sites-enabled/
    ```

4.  **Test and Reload**:
    ```bash
    sudo nginx -t
    sudo systemctl reload nginx
    ```

## 7. Troubleshooting: Where is my Nginx?

Since you have root access, you can find your Nginx configuration in one of these standard locations:

1.  **Main Config**: `/etc/nginx/nginx.conf`
2.  **Site Configs**: `/etc/nginx/sites-available/` or `/etc/nginx/conf.d/`
3.  **Docker Nginx**: If you run Nginx in a container (e.g., Nginx Proxy Manager), the config is inside that container's volume. Check `docker ps` to see if an nginx container is running.

**To find it essentially**:
```bash
sudo find / -name "nginx.conf"
```

## 8. Automated Deployment (GitHub Actions)

We have set up a GitHub Action to automate deployments.

### 1. Generate SSH Key Pair
On your local machine (or any terminal):
```bash
ssh-keygen -t ed25519 -C "github-actions" -f github_deploy_key
```
This generates a private key (`github_deploy_key`) and a public key (`github_deploy_key.pub`).

### 2. Add Public Key to Server
Copy the content of `github_deploy_key.pub` and append it to `~/.ssh/authorized_keys` on your **server**:
```bash
# On your server
echo "paste-public-key-content-here" >> ~/.ssh/authorized_keys
```

### 3. Add Secrets to GitHub
Go to your GitHub Repository -> **Settings** -> **Secrets and variables** -> **Actions** -> **New repository secret**.

Add these 3 secrets:
*   `SSH_HOST`: Your server IP address.
*   `SSH_USER`: `root` (or your user).
*   `SSH_KEY`: The **Private Key** content (from `github_deploy_key`).

### 4. Push to Deploy
Now, whenever you push to the `main` branch, GitHub will automatically SSH into your server, pull the latest code, and rebuild the containers!

## 9. Troubleshooting: Docker Network

If you see an error like `Network whatomate declared as external, but could not be found`, it means the network name is slightly different (Docker Compose adds a prefix).

1.  **Find the real network name**:
    ```bash
    docker network ls
    ```
    Look for something like `whatomate_default` or `folder_name_whatomate`.

2.  **Update `docker-compose.prod.yml`**:
    Edit the file and change the network name at the bottom:

    networks:
      whatomate:
        external: true
        name: whatomate_default  # <--- Change this to the actual name from step 1
    ```

## 10. Troubleshooting: Build Stuck (Out of Memory)

If your build freezes or crashes with "Killed" on a 1GB server, you are running out of RAM.

**Solution: Add Swap Space** (Virtual RAM on disk)
Run these commands on your server:

```bash
# Create a 4GB swap file
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# Make it permanent
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```
